<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - IIMP</title>
    <link rel="icon" type="image/png" href="assets/favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/lipis/flag-icons@7.2.3/css/flag-icons.min.css" />
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'perumin': '#004F59',
                        'perumin-light': '#006B7A',
                        'perumin-dark': '#003A42'
                    },
                    fontFamily: {
                        'inter': ['Inter', 'sans-serif']
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 font-inter" x-data="checkoutApp()">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center justify-between w-full">
                    <div class="flex items-center space-x-3">
                        <img src="assets/LOGO_PERUMIN_37.png" alt="PERUMIN 37" class="h-12 w-auto">
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-[1000px] mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Formulario Principal -->
            <div class="lg:col-span-2">
                <!-- Inscripciones Existentes -->
                <div x-show="existingInscriptions.length > 0" class="mb-6 border border-gray-200 rounded-xl bg-white shadow-sm overflow-hidden">
                    <div class="flex items-center gap-3 px-4 py-3 bg-perumin text-white">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        <strong class="text-sm font-medium">Inscripciones Existentes</strong>
                    </div>
                    <div class="p-4">
                        <ul class="space-y-2">
                            <template x-for="inscription in existingInscriptions" :key="inscription">
                                <li class="flex items-center text-sm text-gray-700">
                                    <svg class="w-4 h-4 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span x-text="inscription"></span>
                                </li>
                            </template>
                        </ul>
                    </div>
                </div>

                <!-- Datos Personales -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 mb-6">
                    <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                        <h2 class="text-lg font-semibold text-perumin" x-text="t('personalData')">Datos Personales</h2>
                        <div class="flex items-center space-x-2">
                            <button 
                                @click="setLanguage('es')" 
                                :class="language === 'es' ? 'bg-perumin text-white' : 'bg-gray-200 text-gray-700'"
                                class="px-3 py-1 rounded-md text-sm font-medium transition-colors flex items-center space-x-1">
                                <i class="fi fi-es w-4 h-4"></i>
                                <span>ES</span>
                            </button>
                            <button 
                                @click="setLanguage('en')" 
                                :class="language === 'en' ? 'bg-perumin text-white' : 'bg-gray-200 text-gray-700'"
                                class="px-3 py-1 rounded-md text-sm font-medium transition-colors flex items-center space-x-1">
                                <i class="fi fi-us w-4 h-4"></i>
                                <span>EN</span>
                            </button>
                        </div>
                    </div>
                    <div class="p-6 space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" x-text="t('docType')">Tipo de Documento</label>
                                <select x-model="formData.docType" @change="handleDocTypeChange()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-perumin focus:border-perumin">
                                    <option value="" x-text="t('selectDocType')">Seleccionar...</option>
                                    <option value="DNI">DNI</option>
                                    <option value="CE">Carnet de Extranjer√≠a</option>
                                    <option value="PASAPORTE">Pasaporte</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" x-text="t('docNumber')">N√∫mero de Documento</label>
                                <input type="text" x-model="formData.docNumber" @input="checkExistingInscriptions(); handleDocTypeChange()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-perumin focus:border-perumin" :placeholder="t('enterDocNumber')">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" x-text="t('firstName')">Nombres</label>
                                <input type="text" x-model="formData.firstName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-perumin focus:border-perumin" :placeholder="t('enterFirstName')">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" x-text="t('lastName')">Apellidos</label>
                                <input type="text" x-model="formData.lastName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-perumin focus:border-perumin" :placeholder="t('enterLastName')">
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" x-text="t('email')">Email</label>
                                <input type="email" x-model="formData.email" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-perumin focus:border-perumin" :placeholder="t('enterEmail')">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" x-text="t('phone')">Tel√©fono</label>
                                <input type="tel" x-model="formData.phone" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-perumin focus:border-perumin" :placeholder="t('enterPhone')">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Secci√≥n de Facturaci√≥n -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200" x-show="formData.docType">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-perumin" x-text="t('billingSection')">Informaci√≥n de Facturaci√≥n</h3>
                    </div>
                    <div class="p-6 space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" x-text="t('receiptType')">Tipo de Comprobante</label>
                                <select x-model="formData.receiptType" @change="updateBillingDocOptions()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-perumin focus:border-perumin">
                                    <option value="03" x-text="t('receiptBoleta')">Boleta</option>
                                    <option value="01" x-text="t('receiptFactura')" x-show="formData.docType === 'DNI'">Factura</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" x-text="t('billingDocType')">Tipo de Documento de Facturaci√≥n</label>
                                <select x-model="formData.billingDocType" @change="updateBillingFields()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-perumin focus:border-perumin">
                                    <option value="" x-text="t('selectBillingDocType')">Seleccionar...</option>
                                    <option value="1" x-text="t('billingDocDNI')" x-show="formData.receiptType === '03'">DNI (Peruano)</option>
                                    <option value="6" x-text="t('billingDocRUC')">RUC</option>
                                    <option value="7" x-text="t('billingDocRUCForeign')">RUC (extranjero)</option>
                                </select>
                            </div>
                        </div>

                        <!-- Campos de RUC y Raz√≥n Social -->
                        <div x-show="formData.billingDocType === '6' || formData.billingDocType === '7'" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" x-text="t('rucNumber')">N√∫mero de RUC</label>
                                <input type="text" x-model="formData.rucNumber" @input="validateRUC()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-perumin focus:border-perumin" :placeholder="t('enterRUC')" maxlength="11">
                                <div x-show="rucValidationMessage" class="mt-1 text-sm" :class="rucValidationStatus === 'success' ? 'text-green-600' : 'text-red-600'" x-text="rucValidationMessage"></div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" x-text="t('businessName')">Raz√≥n Social</label>
                                <input type="text" x-model="formData.businessName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-perumin focus:border-perumin" :placeholder="t('enterBusinessName')" :readonly="rucValidationStatus === 'success'">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" x-text="t('company')">Empresa</label>
                                <input type="text" x-model="formData.billingCompany" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-perumin focus:border-perumin" :placeholder="t('enterBillingCompany')">
                            </div>
                        </div>


                    </div>
                </div>


            </div>

            <!-- Resumen de Compra -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 sticky top-8">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h2 class="text-lg font-semibold text-perumin" x-text="t('purchaseSummary')">Resumen de Compra</h2>
                    </div>
                    <div class="p-6">
                        <div x-show="formData.inscriptionType" class="space-y-4">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600" x-text="language === 'es' ? 'Tipo de Inscripci√≥n:' : 'Inscription Type:'">Tipo de Inscripci√≥n:</span>
                                <span class="font-medium capitalize" x-text="formData.inscriptionType ? t(formData.inscriptionType) : ''"></span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600" x-text="t('category') + ':'">Categor√≠a:</span>
                                <span class="font-medium" x-text="formData.category || (language === 'es' ? 'No seleccionada' : 'Not selected')"></span>
                            </div>
                            <div class="border-t border-gray-200 pt-4">
                                <div class="flex justify-between items-center text-lg font-semibold">
                                    <span x-text="t('total') + ':'">Total:</span>
                                    <span class="text-perumin" x-text="getPrice()"></span>
                                </div>
                            </div>
                        </div>
                        
                        <div x-show="!formData.inscriptionType" class="text-center text-gray-500 py-8">
                            <p x-text="language === 'es' ? 'Seleccione un tipo de inscripci√≥n para ver el resumen' : 'Select an inscription type to see the summary'">Seleccione un tipo de inscripci√≥n para ver el resumen</p>
                        </div>

                        <button @click="processOrder()" :disabled="!isFormValid() || isLoading" class="w-full mt-6 bg-perumin text-white py-3 px-4 rounded-lg font-medium hover:bg-perumin-dark disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors">
                            <span x-show="!isLoading" x-text="t('processInscription')">Procesar Inscripci√≥n</span>
                            <span x-show="isLoading" class="flex items-center justify-center">
                                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                <span x-text="t('processing')">Procesando...</span>
                            </span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function checkoutApp() {
            return {
                language: 'es',
                translations: {
                    es: {
                        personalData: 'Datos Personales',
                        docType: 'Tipo de Documento',
                        docNumber: 'N√∫mero de Documento',
                        firstName: 'Nombres',
                        lastName: 'Apellidos',
                        email: 'Correo Electr√≥nico',
                        phone: 'Tel√©fono',
                        company: 'Empresa',
                        inscriptionType: 'Tipo de Inscripci√≥n',
                        category: 'Categor√≠a',
                        currency: 'Moneda',
                        convencionista: 'Convencionista',
                        extemin: 'Extemin',
                        purchaseSummary: 'Resumen de Compra',
                        total: 'Total',
                        processInscription: 'Procesar Inscripci√≥n',
                        processing: 'Procesando...',
                        selectDocType: 'Selecciona tipo de documento',
                        selectCategory: 'Selecciona categor√≠a',
                        enterDocNumber: 'Ingresa n√∫mero de documento',
                        enterFirstName: 'Ingresa nombres',
                        enterLastName: 'Ingresa apellidos',
                        enterEmail: 'Ingresa correo electr√≥nico',
                        enterPhone: 'Ingresa tel√©fono',
                        enterCompany: 'Ingresa empresa (opcional)',
                        documentType: 'Tipo de Documento',
                        documentNumber: 'N√∫mero de Documento',
                        billingSection: 'Informaci√≥n de Facturaci√≥n',
                        receiptType: 'Tipo de Comprobante',
                        receiptBoleta: 'Boleta',
                        receiptFactura: 'Factura',
                        billingDocType: 'Tipo de Documento de Facturaci√≥n',
                        selectBillingDocType: 'Seleccionar tipo de documento',
                        billingDocDNI: 'DNI (Peruano)',
                        billingDocRUC: 'RUC',
                        billingDocRUCForeign: 'RUC (extranjero)',
                        rucNumber: 'N√∫mero de RUC',
                        enterRUC: 'Ingresa n√∫mero de RUC',
                        businessName: 'Raz√≥n Social',
                        enterBusinessName: 'Raz√≥n Social (se autocompletar√°)',
                        billingDocNumber: 'N√∫mero de Documento',
                        enterBillingDocNumber: 'N√∫mero de documento',
                        enterBillingCompany: 'Ingresa empresa para facturaci√≥n'
                    },
                    en: {
                        personalData: 'Personal Data',
                        docType: 'Document Type',
                        docNumber: 'Document Number',
                        firstName: 'First Name',
                        lastName: 'Last Name',
                        email: 'Email',
                        phone: 'Phone',
                        company: 'Company',
                        inscriptionType: 'Inscription Type',
                        category: 'Category',
                        currency: 'Currency',
                        convencionista: 'Conventionist',
                        extemin: 'Extemin',
                        purchaseSummary: 'Purchase Summary',
                        total: 'Total',
                        processInscription: 'Process Inscription',
                        processing: 'Processing...',
                        selectDocType: 'Select document type',
                        selectCategory: 'Select category',
                        enterDocNumber: 'Enter document number',
                        enterFirstName: 'Enter first name',
                        enterLastName: 'Enter last name',
                        enterEmail: 'Enter email',
                        enterPhone: 'Enter phone',
                        enterCompany: 'Enter company (optional)',
                        documentType: 'Document Type',
                        documentNumber: 'Document Number',
                        billingSection: 'Billing Information',
                        receiptType: 'Receipt Type',
                        receiptBoleta: 'Receipt',
                        receiptFactura: 'Invoice',
                        billingDocType: 'Billing Document Type',
                        selectBillingDocType: 'Select document type',
                        billingDocDNI: 'DNI (Peruvian)',
                        billingDocRUC: 'NIF',
                        billingDocRUCForeign: 'Foreign NIF',
                        rucNumber: 'NIF Number',
                        enterRUC: 'Enter NIF number',
                        businessName: 'Business Name',
                        enterBusinessName: 'Business Name (auto-filled)',
                        billingDocNumber: 'Document Number',
                        enterBillingDocNumber: 'Document number',
                        enterBillingCompany: 'Enter company for billing'
                    }
                },
                formData: {
                    docType: '',
                    docNumber: '',
                    firstName: '',
                    lastName: '',
                    email: '',
                    phone: '',
                    company: '',
                    inscriptionType: '',
                    category: '',
                    currency: 'USD',
                    isLoading: false,
                    // Campos de facturaci√≥n
                    receiptType: '03', // Boleta por defecto
                    billingDocType: '',
                    rucNumber: '',
                    businessName: '',
                    billingCompany: '',
                    billingDocNumber: ''
                },
                existingInscriptions: [],
                isLoading: false,
                // Variables para validaci√≥n de RUC
                rucValidationMessage: '',
                rucValidationStatus: '', // 'success', 'error', ''
                rucTimeout: null,
                
                // Inicializaci√≥n - poblar campos desde URL
                init() {
                    console.log('Iniciando Alpine.js component');
                    this.populateFromURL();
                    console.log('Despu√©s de populateFromURL, docType:', this.formData.docType);
                },
                
                // Poblar campos desde par√°metros URL
                populateFromURL() {
                    const urlParams = new URLSearchParams(window.location.search);
                    
                    // Mapear par√°metros de URL a campos del formulario
                    if (urlParams.get('name')) {
                        const fullName = urlParams.get('name').split(' ');
                        this.formData.firstName = fullName[0] || '';
                        this.formData.lastName = fullName.slice(1).join(' ') || '';
                    }
                    
                    if (urlParams.get('email')) {
                        this.formData.email = urlParams.get('email');
                    }
                    
                    if (urlParams.get('document_type')) {
                        const docTypeCode = urlParams.get('document_type');
                        console.log('C√≥digo recibido:', docTypeCode, 'tipo:', typeof docTypeCode);
                        
                        // Mapear c√≥digos num√©ricos a tipos de documento
                        const docTypeMapping = {
                            '1': 'DNI',
                            '4': 'CE', 
                            '7': 'PASAPORTE'
                        };
                        
                        console.log('Mapeo disponible:', docTypeMapping);
                        const mappedValue = docTypeMapping[docTypeCode];
                        console.log('Valor mapeado directo:', mappedValue);
                        
                        if (mappedValue) {
                            this.formData.docType = mappedValue;
                            console.log('Asignado:', this.formData.docType);
                            // Verificar despu√©s de un momento si el select se actualiz√≥
                            setTimeout(() => {
                                console.log('Verificaci√≥n despu√©s de timeout - docType:', this.formData.docType);
                                const selectElement = document.querySelector('select[x-model="formData.docType"]');
                                console.log('Valor del select element:', selectElement ? selectElement.value : 'No encontrado');
                            }, 100);
                        } else {
                            console.log('No se encontr√≥ mapeo para c√≥digo:', docTypeCode);
                            this.formData.docType = docTypeCode;
                        }
                    }
                    
                    if (urlParams.get('document_number')) {
                        this.formData.docNumber = urlParams.get('document_number');
                    }
                    
                    if (urlParams.get('phone')) {
                        this.formData.phone = urlParams.get('phone');
                    }
                    
                    if (urlParams.get('company')) {
                        this.formData.company = urlParams.get('company');
                    }
                    
                    if (urlParams.get('product_id')) {
                        this.setInscriptionFromProductId(urlParams.get('product_id'));
                    }
                    
                    if (urlParams.get('language')) {
                        this.language = urlParams.get('language');
                    }
                },
                
                // Configurar tipo de inscripci√≥n y categor√≠a basado en product_id
                setInscriptionFromProductId(productId) {
                    // Buscar en productos de convencionista
                    for (const [id, data] of Object.entries(this.products.convencionista)) {
                        if (id === productId) {
                            this.formData.inscriptionType = 'convencionista';
                            this.formData.category = data.category;
                            return;
                        }
                    }
                    
                    // Buscar en productos de extemin
                    for (const [id, data] of Object.entries(this.products.extemin)) {
                        if (id === productId) {
                            this.formData.inscriptionType = 'extemin';
                            this.formData.category = data.category;
                            return;
                        }
                    }
                },
                
                async checkExistingInscriptions() {
                    if (!this.formData.docType || !this.formData.docNumber) {
                        this.existingInscriptions = [];
                        return;
                    }
                    
                    try {
                        // Mapear tipos de documento seg√∫n la l√≥gica del PHP
                        const docTypeMapping = {
                            'DNI': '1',
                            'CE': '4',
                            'PASAPORTE': '7'
                        };
                        
                        const mappedDocType = docTypeMapping[this.formData.docType] || this.formData.docType;
                        
                        const requestData = {
                            TipEvCod: 2,
                            EvenCod: 16,
                            TipoDocumento: mappedDocType,
                            NumeroDocumento: this.formData.docNumber
                        };
                        
                        const response = await fetch('/api/v1/check-inscriptions', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(requestData)
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            this.existingInscriptions = result.inscriptions || [];
                        } else {
                            this.existingInscriptions = [];
                        }
                    } catch (error) {
                        console.error('Error checking inscriptions:', error);
                        this.existingInscriptions = [];
                    }
                },
                
                // Funciones para manejar la l√≥gica de facturaci√≥n
                handleDocTypeChange() {
                    // L√≥gica autom√°tica seg√∫n el tipo de documento
                    if (this.formData.docType === 'DNI') {
                        // DNI ‚Üí Boleta autom√°tica
                        this.formData.receiptType = '03';
                        this.formData.billingDocType = '1'; // DNI
                        this.formData.billingDocNumber = this.formData.docNumber;
                    } else if (this.formData.docType === 'CE' || this.formData.docType === 'PASAPORTE') {
                        // Otros documentos ‚Üí Boleta + RUC extranjero
                        this.formData.receiptType = '03';
                        this.formData.billingDocType = '7'; // RUC extranjero
                        this.formData.rucNumber = this.formData.docNumber;
                        this.formData.businessName = (this.formData.firstName + ' ' + this.formData.lastName).trim();
                    }
                    
                    // Limpiar validaciones
                    this.rucValidationMessage = '';
                    this.rucValidationStatus = '';
                },
                
                updateBillingDocOptions() {
                    // Resetear campos cuando cambia el tipo de comprobante
                    this.formData.billingDocType = '';
                    this.formData.rucNumber = '';
                    this.formData.businessName = '';
                    this.formData.billingDocNumber = '';
                    this.rucValidationMessage = '';
                    this.rucValidationStatus = '';
                    
                    // Si es factura, solo permitir RUC
                    if (this.formData.receiptType === '01') {
                        this.formData.billingDocType = '6';
                        this.updateBillingFields();
                    }
                },
                
                updateBillingFields() {
                    // Limpiar campos cuando cambia el tipo de documento de facturaci√≥n
                    this.formData.rucNumber = '';
                    this.formData.businessName = '';
                    this.formData.billingDocNumber = '';
                    this.rucValidationMessage = '';
                    this.rucValidationStatus = '';
                    
                    // Si es DNI, usar el n√∫mero de documento principal
                    if (this.formData.billingDocType === '1') {
                        this.formData.billingDocNumber = this.formData.docNumber;
                    }
                },
                
                validateRUC() {
                    const ruc = this.formData.rucNumber.trim();
                    
                    // Limpiar timeout anterior
                    if (this.rucTimeout) {
                        clearTimeout(this.rucTimeout);
                    }
                    
                    // Resetear validaci√≥n
                    this.rucValidationMessage = '';
                    this.rucValidationStatus = '';
                    
                    // Si es RUC extranjero (valor 7), no validar autom√°ticamente
                    if (this.formData.billingDocType === '7') {
                        return;
                    }
                    
                    this.formData.businessName = '';
                    
                    // Validar formato de RUC (11 d√≠gitos)
                    if (!/^\d{11}$/.test(ruc)) {
                        if (ruc.length > 0) {
                            this.rucValidationMessage = this.language === 'es' ? 'RUC debe tener 11 d√≠gitos' : 'RUC must have 11 digits';
                            this.rucValidationStatus = 'error';
                        }
                        return;
                    }
                    
                    // Consultar RUC despu√©s de 1 segundo
                    this.rucTimeout = setTimeout(() => {
                        this.lookupRUC(ruc);
                    }, 1000);
                },
                
                async lookupRUC(ruc) {
                    console.log('üîç Iniciando consulta RUC:', ruc);
                    
                    try {
                        this.rucValidationMessage = this.language === 'es' ? 'Consultando RUC...' : 'Looking up RUC...';
                        this.rucValidationStatus = '';
                        
                        console.log('üì° Enviando request a /api/v1/consultar-ruc');
                        const response = await fetch('/api/v1/consultar-ruc', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ ruc: ruc })
                        });
                        
                        console.log('üì• Response status:', response.status, response.statusText);
                        
                        if (response.ok) {
                            const result = await response.json();
                            console.log('üìã Response data:', result);
                            
                            // Verificar ambos formatos de respuesta (razonSocial y razon_social)
                            const businessName = result.razonSocial || result.razon_social || (result.data && result.data.razon_social);
                            console.log('üè¢ Business name found:', businessName);
                            
                            if (result.success && businessName) {
                                this.formData.businessName = businessName;
                                this.rucValidationMessage = this.language === 'es' ? 'RUC v√°lido' : 'Valid RUC';
                                this.rucValidationStatus = 'success';
                                console.log('‚úÖ RUC validation successful');
                            } else {
                                this.rucValidationMessage = this.language === 'es' ? 'RUC no encontrado' : 'RUC not found';
                                this.rucValidationStatus = 'error';
                                console.log('‚ùå RUC not found or invalid response');
                            }
                        } else {
                            const errorText = await response.text();
                            console.error('‚ùå HTTP Error:', response.status, errorText);
                            this.rucValidationMessage = this.language === 'es' ? 'Error al consultar RUC' : 'Error looking up RUC';
                            this.rucValidationStatus = 'error';
                        }
                    } catch (error) {
                        console.error('üí• Network/Parse Error:', error);
                        this.rucValidationMessage = this.language === 'es' ? 'Error al consultar RUC' : 'Error looking up RUC';
                        this.rucValidationStatus = 'error';
                    }
                },
                
                // Productos basados en productos.md con precios por categor√≠a
                products: {
                    convencionista: {
                        150: { category: 'ASOCIADO_SME', price_usd: 1700, price_pen: 6290 },
                        151: { category: 'DOCENTE', price_usd: 400, price_pen: 1480 },
                        152: { category: 'ESTUDIANTE', price_usd: 250, price_pen: 925 },
                        154: { category: 'NO_ASOCIADO', price_usd: 1900, price_pen: 7030 },
                        155: { category: 'ASOCIADO_ACTIVO', price_usd: 1700, price_pen: 6290 }
                    },
                    extemin: {
                        158: { category: 'WEEK', price_usd: 790, price_pen: 2924 }
                    }
                },
                
                // Funci√≥n para obtener el precio basado en tipo de inscripci√≥n, categor√≠a y moneda
                getPrice() {
                    if (!this.formData.inscriptionType || !this.formData.category) return '';
                    
                    const productData = this.getProductData();
                    if (!productData) return '';
                    
                    const price = this.formData.currency === 'USD' ? productData.price_usd : productData.price_pen;
                    const symbol = this.formData.currency === 'USD' ? '$' : 'S/';
                    
                    return `${symbol}${price.toLocaleString()} ${this.formData.currency}`;
                },
                
                // Funci√≥n para obtener el valor num√©rico del precio
                getPriceValue() {
                    if (!this.formData.inscriptionType || !this.formData.category) return 0;
                    
                    const productData = this.getProductData();
                    if (!productData) return 0;
                    
                    return this.formData.currency === 'USD' ? productData.price_usd : productData.price_pen;
                },
                
                // Funci√≥n para obtener los datos del producto basado en tipo y categor√≠a
                getProductData() {
                    const typeProducts = this.products[this.formData.inscriptionType];
                    if (!typeProducts) return null;
                    
                    // Buscar el producto que coincida con la categor√≠a seleccionada
                    for (const [productId, productData] of Object.entries(typeProducts)) {
                        if (productData.category === this.formData.category) {
                            return { ...productData, id: productId };
                        }
                    }
                    
                    return null;
                },
                
                // Funci√≥n para obtener el ID del producto
                getProductId() {
                    const productData = this.getProductData();
                    return productData ? productData.id : null;
                },
                
                // Funci√≥n para mostrar precio de convencionista basado en categor√≠a
                getConvencionistaPrice() {
                    if (!this.formData.category) {
                        // Mostrar rango de precios si no hay categor√≠a seleccionada
                        return this.formData.currency === 'USD' ? '$250 - $1,900 USD' : 'S/925 - S/7,030 PEN';
                    }
                    
                    const typeProducts = this.products.convencionista;
                    for (const [productId, productData] of Object.entries(typeProducts)) {
                        if (productData.category === this.formData.category) {
                            const price = this.formData.currency === 'USD' ? productData.price_usd : productData.price_pen;
                            const symbol = this.formData.currency === 'USD' ? '$' : 'S/';
                            return `${symbol}${price.toLocaleString()} ${this.formData.currency}`;
                        }
                    }
                    
                    return this.formData.currency === 'USD' ? '$250 - $1,900 USD' : 'S/925 - S/7,030 PEN';
                },
                
                // Funci√≥n para mostrar precio de extemin
                getExteminPrice() {
                    const price = this.formData.currency === 'USD' ? 790 : 2924;
                    const symbol = this.formData.currency === 'USD' ? '$' : 'S/';
                    return `${symbol}${price.toLocaleString()} ${this.formData.currency}`;
                },
                

                
                isFormValid() {
                    return this.formData.docType && 
                           this.formData.docNumber && 
                           this.formData.firstName && 
                           this.formData.lastName && 
                           this.formData.email && 
                           this.formData.phone && 
                           this.formData.inscriptionType && 
                           this.formData.category;
                },
                
                async processOrder() {
                    if (!this.isFormValid()) {
                        alert('Por favor complete todos los campos requeridos');
                        return;
                    }
                    
                    this.isLoading = true;
                    
                    try {
                        const productId = this.getProductId();
                        if (!productId) {
                            throw new Error('No se pudo determinar el producto');
                        }
                        
                        const orderData = {
                            product_id: productId,
                            email: this.formData.email,
                            nombres: this.formData.firstName,
                            apellidos: this.formData.lastName,
                            celular: this.formData.phone,
                            empresa: this.formData.company,
                            tipo_documento: this.formData.docType,
                            numero_documento: this.formData.docNumber,
                            inscription_type: this.formData.inscriptionType,
                            category: this.formData.category,
                            currency: this.formData.currency,
                            total_amount: this.getPriceValue(),
                            language: this.language,
                            status: 'pending'
                        };
                        
                        const response = await fetch('/api/v1/orders', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(orderData)
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            
                            // Preparar datos completos para la p√°gina de agradecimiento
                            const completeOrderData = {
                                ...orderData,
                                id: result.id,
                                created_at: new Date().toISOString()
                            };
                            
                            // Guardar en localStorage como respaldo
                            localStorage.setItem('lastOrderData', JSON.stringify(completeOrderData));
                            
                            // Redirigir a p√°gina de agradecimiento con datos
                            const orderDataParam = encodeURIComponent(JSON.stringify(completeOrderData));
                            window.location.href = `thank-you.html?orderData=${orderDataParam}`;
                        } else {
                            const error = await response.json();
                            const errorMessage = this.language === 'es' ? 'Error al procesar la inscripci√≥n' : 'Error processing inscription';
                            alert(`${errorMessage}: ${error.detail || 'Error desconocido'}`);
                        }
                    } catch (error) {
                        console.error('Error al enviar formulario:', error);
                        const errorMessage = this.language === 'es' ? 'Error de conexi√≥n. Por favor, intente nuevamente.' : 'Connection error. Please try again.';
                        alert(errorMessage);
                    } finally {
                        this.isLoading = false;
                    }
                },
                
                resetForm() {
                    this.formData = {
                        docType: '',
                        docNumber: '',
                        firstName: '',
                        lastName: '',
                        email: '',
                        phone: '',
                        company: '',
                        inscriptionType: '',
                        category: '',
                        currency: 'USD',
                        isLoading: false
                    };
                    this.existingInscriptions = [];
                },
                setLanguage(lang) {
                    this.language = lang;
                },
                t(key) {
                    return this.translations[this.language][key] || key;
                }
            }
        }
    </script>
</body>
</html>