<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - IIMP</title>
    <link rel="icon" type="image/png" href="assets/favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/lipis/flag-icons@7.2.3/css/flag-icons.min.css" />
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'perumin': '#004F59',
                        'perumin-light': '#006B7A',
                        'perumin-dark': '#003A42'
                    },
                    fontFamily: {
                        'inter': ['Inter', 'sans-serif']
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 font-inter" x-data="checkoutApp()">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center justify-between w-full">
                    <div class="flex items-center space-x-3">
                        <img src="assets/LOGO_PERUMIN_37.png" alt="PERUMIN 37" class="h-12 w-auto">
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-[1000px] mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Resumen de Compra -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 sticky top-8">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h2 class="text-lg font-semibold text-perumin" x-text="t('purchaseSummary')">Resumen de Compra</h2>
                    </div>
                    <div class="p-6">
                        <div x-show="formData.inscriptionType" class="space-y-4">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600" x-text="language === 'es' ? 'Tipo de Inscripción:' : 'Inscription Type:'">Tipo de Inscripción:</span>
                                <span class="font-medium capitalize" x-text="formData.inscriptionType ? t(formData.inscriptionType) : ''"></span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600" x-text="t('category') + ':'">Categoría:</span>
                                <span class="font-medium" x-text="formData.category || (language === 'es' ? 'No seleccionada' : 'Not selected')"></span>
                            </div>
                            <div class="border-t border-gray-200 pt-4">
                                <div class="flex justify-between items-center text-lg font-semibold">
                                    <span x-text="t('total') + ':'">Total:</span>
                                    <span class="text-perumin" x-text="getPrice()"></span>
                                </div>
                            </div>
                            
                            <!-- Opción de compra por día para productos de entrenamiento -->
                            <div x-show="(getProductId() === '158' || getProductId() === '154') && formData.inscriptionType" class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                <div class="mb-3">
                                    <p class="text-sm font-medium text-gray-700" x-text="language === 'es' ? '¿Deseas comprar por día?' : 'Do you want to buy per day?'">¿Deseas comprar por día?</p>
                                    <p class="text-xs text-gray-500 mt-1" x-text="language === 'es' ? 'Selecciona días específicos de asistencia' : 'Select specific attendance days'">Selecciona días específicos de asistencia</p>
                                </div>
                                <div class="flex space-x-3">
                                    <button @click="enableDaySelection(false)" 
                                            :class="!showDaySelection ? 'bg-perumin text-white' : 'bg-white text-gray-700 border border-gray-300'"
                                            class="flex-1 py-2 px-3 rounded-md text-sm font-medium transition-colors">
                                        <span x-text="language === 'es' ? 'Precio completo' : 'Full price'">Precio completo</span>
                                    </button>
                                    <button @click="enableDaySelection(true)" 
                                            :class="showDaySelection ? 'bg-perumin text-white' : 'bg-white text-gray-700 border border-gray-300'"
                                            class="flex-1 py-2 px-3 rounded-md text-sm font-medium transition-colors">
                                        <span x-text="language === 'es' ? 'Por día' : 'Per day'">Por día</span>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Selección de días cuando está habilitada -->
                            <div x-show="showDaySelection" class="mt-4 space-y-3">
                                <div class="space-y-2">
                                    <div class="day-option">
                                        <label class="flex items-center justify-between p-2 border border-gray-200 rounded-md cursor-pointer hover:border-perumin transition-all duration-200" :class="formData.selectedDays.includes('monday') ? 'border-perumin bg-perumin/5' : ''">
                                            <div class="flex items-center space-x-2">
                                                <input type="checkbox" x-model="formData.selectedDays" value="monday" @change="updateTotalPrice()" class="sr-only">
                                                <div class="w-4 h-4 rounded-full border-2 flex items-center justify-center transition-colors"
                                                     :class="formData.selectedDays.includes('monday') ? 'border-perumin bg-perumin' : 'border-gray-300'">
                                                    <svg x-show="formData.selectedDays.includes('monday')" class="w-2 h-2 text-white" fill="currentColor" viewBox="0 0 20 20">
                                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                                    </svg>
                                                </div>
                                                <div>
                                                    <span class="text-sm font-medium" :class="formData.selectedDays.includes('monday') ? 'text-perumin' : 'text-gray-900'" x-text="language === 'es' ? 'Lunes 22 Sept' : 'Monday 22 Sept'">Lunes 22 Sept</span>
                                                </div>
                                            </div>
                                            <span class="text-sm font-semibold text-perumin" x-text="'$' + currentProductPrice.toLocaleString()">$250</span>
                                        </label>
                                    </div>
                                    
                                    <div class="day-option">
                                        <label class="flex items-center justify-between p-2 border border-gray-200 rounded-md cursor-pointer hover:border-perumin transition-all duration-200" :class="formData.selectedDays.includes('tuesday') ? 'border-perumin bg-perumin/5' : ''">
                                            <div class="flex items-center space-x-2">
                                                <input type="checkbox" x-model="formData.selectedDays" value="tuesday" @change="updateTotalPrice()" class="sr-only">
                                                <div class="w-4 h-4 rounded-full border-2 flex items-center justify-center transition-colors"
                                                     :class="formData.selectedDays.includes('tuesday') ? 'border-perumin bg-perumin' : 'border-gray-300'">
                                                    <svg x-show="formData.selectedDays.includes('tuesday')" class="w-2 h-2 text-white" fill="currentColor" viewBox="0 0 20 20">
                                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                                    </svg>
                                                </div>
                                                <div>
                                                    <span class="text-sm font-medium" :class="formData.selectedDays.includes('tuesday') ? 'text-perumin' : 'text-gray-900'" x-text="language === 'es' ? 'Martes 23 Sept' : 'Tuesday 23 Sept'">Martes 23 Sept</span>
                                                </div>
                                            </div>
                                            <span class="text-sm font-semibold text-perumin" x-text="'$' + currentProductPrice.toLocaleString()">$250</span>
                                        </label>
                                    </div>
                                    
                                    <div class="day-option">
                                        <label class="flex items-center justify-between p-2 border border-gray-200 rounded-md cursor-pointer hover:border-perumin transition-all duration-200" :class="formData.selectedDays.includes('wednesday') ? 'border-perumin bg-perumin/5' : ''">
                                            <div class="flex items-center space-x-2">
                                                <input type="checkbox" x-model="formData.selectedDays" value="wednesday" @change="updateTotalPrice()" class="sr-only">
                                                <div class="w-4 h-4 rounded-full border-2 flex items-center justify-center transition-colors"
                                                     :class="formData.selectedDays.includes('wednesday') ? 'border-perumin bg-perumin' : 'border-gray-300'">
                                                    <svg x-show="formData.selectedDays.includes('wednesday')" class="w-2 h-2 text-white" fill="currentColor" viewBox="0 0 20 20">
                                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                                    </svg>
                                                </div>
                                                <div>
                                                    <span class="text-sm font-medium" :class="formData.selectedDays.includes('wednesday') ? 'text-perumin' : 'text-gray-900'" x-text="language === 'es' ? 'Miércoles 24 Sept' : 'Wednesday 24 Sept'">Miércoles 24 Sept</span>
                                                </div>
                                            </div>
                                            <span class="text-sm font-semibold text-perumin" x-text="'$' + currentProductPrice.toLocaleString()">$250</span>
                                        </label>
                                    </div>
                                    
                                    <div class="day-option">
                                        <label class="flex items-center justify-between p-2 border border-gray-200 rounded-md cursor-pointer hover:border-perumin transition-all duration-200" :class="formData.selectedDays.includes('thursday') ? 'border-perumin bg-perumin/5' : ''">
                                            <div class="flex items-center space-x-2">
                                                <input type="checkbox" x-model="formData.selectedDays" value="thursday" @change="updateTotalPrice()" class="sr-only">
                                                <div class="w-4 h-4 rounded-full border-2 flex items-center justify-center transition-colors"
                                                     :class="formData.selectedDays.includes('thursday') ? 'border-perumin bg-perumin' : 'border-gray-300'">
                                                    <svg x-show="formData.selectedDays.includes('thursday')" class="w-2 h-2 text-white" fill="currentColor" viewBox="0 0 20 20">
                                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                                    </svg>
                                                </div>
                                                <div>
                                                    <span class="text-sm font-medium" :class="formData.selectedDays.includes('thursday') ? 'text-perumin' : 'text-gray-900'" x-text="language === 'es' ? 'Jueves 25 Sept' : 'Thursday 25 Sept'">Jueves 25 Sept</span>
                                                </div>
                                            </div>
                                            <span class="text-sm font-semibold text-perumin" x-text="'$' + currentProductPrice.toLocaleString()">$250</span>
                                        </label>
                                    </div>
                                    
                                    <div class="day-option">
                                        <label class="flex items-center justify-between p-2 border border-gray-200 rounded-md cursor-pointer hover:border-perumin transition-all duration-200" :class="formData.selectedDays.includes('friday') ? 'border-perumin bg-perumin/5' : ''">
                                            <div class="flex items-center space-x-2">
                                                <input type="checkbox" x-model="formData.selectedDays" value="friday" @change="updateTotalPrice()" class="sr-only">
                                                <div class="w-4 h-4 rounded-full border-2 flex items-center justify-center transition-colors"
                                                     :class="formData.selectedDays.includes('friday') ? 'border-perumin bg-perumin' : 'border-gray-300'">
                                                    <svg x-show="formData.selectedDays.includes('friday')" class="w-2 h-2 text-white" fill="currentColor" viewBox="0 0 20 20">
                                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                                    </svg>
                                                </div>
                                                <div>
                                                    <span class="text-sm font-medium" :class="formData.selectedDays.includes('friday') ? 'text-perumin' : 'text-gray-900'" x-text="language === 'es' ? 'Viernes 26 Sept' : 'Friday 26 Sept'">Viernes 26 Sept</span>
                                                </div>
                                            </div>
                                            <span class="text-sm font-semibold text-perumin" x-text="'$' + currentProductPrice.toLocaleString()">$250</span>
                                        </label>
                                    </div>
                                </div>
                                
                                <div x-show="formData.selectedDays.length === 0" class="mt-3 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                                    <div class="flex items-center space-x-2">
                                        <svg class="w-4 h-4 text-yellow-600" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                        </svg>
                                        <p class="text-xs text-yellow-800" x-text="t('selectAtLeastOneDay')">Debes seleccionar al menos un día de asistencia.</p>
                                    </div>
                                </div>
                            </div>
                            
                            <button x-show="formData.inscriptionType && formData.category && formData.docType && formData.docNumber && formData.firstName && formData.lastName && formData.email && formData.phone" 
                                    @click="processInscription()" 
                                    class="w-full bg-perumin text-white py-3 px-4 rounded-lg font-medium hover:bg-perumin-dark transition-colors">
                                <span x-text="t('processInscription')">Procesar Inscripción</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Formulario Principal -->
            <div class="lg:col-span-2">
                <!-- Inscripciones Existentes -->
                <div x-show="existingInscriptions.length > 0" class="mb-6 border border-gray-200 rounded-xl bg-white shadow-sm overflow-hidden">
                    <div class="flex items-center gap-3 px-4 py-3 bg-perumin text-white">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        <strong class="text-sm font-medium">Inscripciones Existentes</strong>
                    </div>
                    <div class="p-4">
                        <ul class="space-y-2">
                            <template x-for="inscription in existingInscriptions" :key="inscription">
                                <li class="flex items-center text-sm text-gray-700">
                                    <svg class="w-4 h-4 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span x-text="inscription"></span>
                                </li>
                            </template>
                        </ul>
                    </div>
                </div>

                <!-- Datos Personales -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 mb-6">
                    <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                        <h2 class="text-lg font-semibold text-perumin" x-text="t('personalData')">Datos Personales</h2>
                        <div class="flex items-center space-x-2">
                            <button 
                                @click="setLanguage('es')" 
                                :class="language === 'es' ? 'bg-perumin text-white' : 'bg-gray-200 text-gray-700'"
                                class="px-3 py-1 rounded-md text-sm font-medium transition-colors flex items-center space-x-1">
                                <i class="fi fi-es w-4 h-4"></i>
                                <span>ES</span>
                            </button>
                            <button 
                                @click="setLanguage('en')" 
                                :class="language === 'en' ? 'bg-perumin text-white' : 'bg-gray-200 text-gray-700'"
                                class="px-3 py-1 rounded-md text-sm font-medium transition-colors flex items-center space-x-1">
                                <i class="fi fi-us w-4 h-4"></i>
                                <span>EN</span>
                            </button>
                        </div>
                    </div>
                    <div class="p-6 space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" x-text="t('docType')">Tipo de Documento</label>
                                <select x-model="formData.docType" @change="handleDocTypeChange()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-perumin focus:border-perumin">
                                    <option value="" x-text="t('selectDocType')">Seleccionar...</option>
                                    <option value="DNI">DNI</option>
                                    <option value="CE">Carnet de Extranjería</option>
                                    <option value="PASAPORTE">Pasaporte</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" x-text="t('docNumber')">Número de Documento</label>
                                <input type="text" x-model="formData.docNumber" @input="checkExistingInscriptions(); handleDocTypeChange()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-perumin focus:border-perumin" :placeholder="t('enterDocNumber')">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" x-text="t('firstName')">Nombres</label>
                                <input type="text" x-model="formData.firstName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-perumin focus:border-perumin" :placeholder="t('enterFirstName')">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" x-text="t('lastName')">Apellidos</label>
                                <input type="text" x-model="formData.lastName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-perumin focus:border-perumin" :placeholder="t('enterLastName')">
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" x-text="t('email')">Email</label>
                                <input type="email" x-model="formData.email" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-perumin focus:border-perumin" :placeholder="t('enterEmail')">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" x-text="t('phone')">Teléfono</label>
                                <input type="tel" x-model="formData.phone" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-perumin focus:border-perumin" :placeholder="t('enterPhone')">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sección de Facturación -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200" x-show="formData.docType">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-perumin" x-text="t('billingSection')">Información de Facturación</h3>
                    </div>
                    <div class="p-6 space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" x-text="t('receiptType')">Tipo de Comprobante</label>
                                <select x-model="formData.receiptType" @change="updateBillingDocOptions()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-perumin focus:border-perumin">
                                    <option value="03" x-text="t('receiptBoleta')">Boleta</option>
                                    <option value="01" x-text="t('receiptFactura')" x-show="formData.docType === 'DNI'">Factura</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" x-text="t('billingDocType')">Tipo de Documento de Facturación</label>
                                <select x-model="formData.billingDocType" @change="updateBillingFields()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-perumin focus:border-perumin">
                                    <option value="" x-text="t('selectBillingDocType')">Seleccionar...</option>
                                    <option value="1" x-text="t('billingDocDNI')" x-show="formData.receiptType === '03'">DNI (Peruano)</option>
                                    <option value="6" x-text="t('billingDocRUC')">RUC</option>
                                    <option value="7" x-text="t('billingDocRUCForeign')">RUC (extranjero)</option>
                                </select>
                            </div>
                        </div>

                        <!-- Campos de RUC y Razón Social -->
                        <div x-show="formData.billingDocType === '6' || formData.billingDocType === '7'" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" x-text="t('rucNumber')">Número de RUC</label>
                                <input type="text" x-model="formData.rucNumber" @input="validateRUC()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-perumin focus:border-perumin" :placeholder="t('enterRUC')" maxlength="11">
                                <div x-show="rucValidationMessage" class="mt-1 text-sm" :class="rucValidationStatus === 'success' ? 'text-green-600' : 'text-red-600'" x-text="rucValidationMessage"></div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" x-text="t('businessName')">Razón Social</label>
                                <input type="text" x-model="formData.businessName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-perumin focus:border-perumin" :placeholder="t('enterBusinessName')" :readonly="rucValidationStatus === 'success'">
                            </div>

                        </div>


                    </div>
                </div>

                <!-- Day Selection for Training Products - Moved to Purchase Summary -->
                        </div>
                    </div>
                </div>


            </div>


        </div>
    </div>

    <script>
        function checkoutApp() {
            return {
                language: 'es',
                translations: {
                    es: {
                        personalData: 'Datos Personales',
                        docType: 'Tipo de Documento',
                        docNumber: 'Número de Documento',
                        firstName: 'Nombres',
                        lastName: 'Apellidos',
                        email: 'Correo Electrónico',
                        phone: 'Teléfono',
                        inscriptionType: 'Tipo de Inscripción',
                        category: 'Categoría',
                        currency: 'Moneda',
                        convencionista: 'Convencionista',
                        extemin: 'Extemin',
                        purchaseSummary: 'Resumen de Compra',
                        total: 'Total',
                        processInscription: 'Procesar Inscripción',
                        processing: 'Procesando...',
                        selectDocType: 'Selecciona tipo de documento',
                        selectCategory: 'Selecciona categoría',
                        enterDocNumber: 'Ingresa número de documento',
                        enterFirstName: 'Ingresa nombres',
                        enterLastName: 'Ingresa apellidos',
                        enterEmail: 'Ingresa correo electrónico',
                        enterPhone: 'Ingresa teléfono',
                        documentType: 'Tipo de Documento',
                        documentNumber: 'Número de Documento',
                        billingSection: 'Información de Facturación',
                        receiptType: 'Tipo de Comprobante',
                        receiptBoleta: 'Boleta',
                        receiptFactura: 'Factura',
                        billingDocType: 'Tipo de Documento de Facturación',
                        selectBillingDocType: 'Seleccionar tipo de documento',
                        billingDocDNI: 'DNI (Peruano)',
                        billingDocRUC: 'RUC (Perú)',
                        billingDocRUCForeign: 'RUC (extranjero)',
                        rucNumber: 'Número de RUC',
                        enterRUC: 'Ingresa número de RUC',
                        businessName: 'Razón Social',
                        enterBusinessName: 'Razón Social (se autocompletará)',
                        billingDocNumber: 'Número de Documento',
                        enterBillingDocNumber: 'Número de documento',
                        selectAtLeastOneDay: 'Debes seleccionar al menos un día de asistencia.',
                        academicPeruOnly: 'Los productos académicos están disponibles solo para peruanos con DNI.',
                        smePeruOnly: 'El producto SME está disponible solo para peruanos con DNI.'
                    },
                    en: {
                        personalData: 'Personal Data',
                        docType: 'Document Type',
                        docNumber: 'Document Number',
                        firstName: 'First Name',
                        lastName: 'Last Name',
                        email: 'Email',
                        phone: 'Phone',
                        inscriptionType: 'Inscription Type',
                        category: 'Category',
                        currency: 'Currency',
                        convencionista: 'Conventionist',
                        extemin: 'Extemin',
                        purchaseSummary: 'Purchase Summary',
                        total: 'Total',
                        processInscription: 'Process Inscription',
                        processing: 'Processing...',
                        selectDocType: 'Select document type',
                        selectCategory: 'Select category',
                        enterDocNumber: 'Enter document number',
                        enterFirstName: 'Enter first name',
                        enterLastName: 'Enter last name',
                        enterEmail: 'Enter email',
                        enterPhone: 'Enter phone',
                        documentType: 'Document Type',
                        documentNumber: 'Document Number',
                        billingSection: 'Billing Information',
                        receiptType: 'Receipt Type',
                        receiptBoleta: 'Receipt',
                        receiptFactura: 'Invoice',
                        billingDocType: 'Billing Document Type',
                        selectBillingDocType: 'Select document type',
                        billingDocDNI: 'DNI (Peruvian)',
                        billingDocRUC: 'NIF',
                        billingDocRUCForeign: 'Foreign NIF',
                        rucNumber: 'NIF Number',
                        enterRUC: 'Enter NIF number',
                        businessName: 'Business Name',
                        enterBusinessName: 'Business Name (auto-filled)',
                        billingDocNumber: 'Document Number',
                        enterBillingDocNumber: 'Document number',
                        daySelection: 'Day Selection',
                        selectDays: 'Select attendance days',
                        monday: 'Monday 22',
                        tuesday: 'Tuesday 23',
                        wednesday: 'Wednesday 24',
                        thursday: 'Thursday 25',
                        friday: 'Friday 26',
                        pricePerDay: 'Price per day',
                        totalPrice: 'Total price',
                        selectAtLeastOneDay: 'You must select at least one attendance day.',
                        academicPeruOnly: 'Academic products are available only for Peruvians with DNI.',
                        smePeruOnly: 'SME product is available only for Peruvians with DNI.'
                    }
                },
                formData: {
                    docType: '',
                    docNumber: '',
                    firstName: '',
                    lastName: '',
                    email: '',
                    phone: '',
                    inscriptionType: '',
                    category: '',
                    currency: 'USD',
                    isLoading: false,
                    // Campos de facturación
                    receiptType: '03', // Boleta por defecto
                    billingDocType: '1', // DNI peruano por defecto
                    rucNumber: '',
                    businessName: '',
                    billingDocNumber: '',
                    // Campos para selección de días
                    selectedDays: [],
                    productId: null
                },
                existingInscriptions: [],
                isLoading: false,
                // Variables para validación de RUC
                rucValidationMessage: '',
                rucValidationStatus: '', // 'success', 'error', ''
                rucTimeout: null,
                // Variables para selección de días
                showDaySelection: false,
                currentProductPrice: 250,
                productPrices: {
                    '158': 250,
                    '154': 700
                },
                // Variables para validación documental
                showDocumentValidationModal: false,
                documentValidationType: '', // 'academic' o 'sme'
                academicType: '', // 'student' o 'teacher'
                documentValidationStatus: '', // 'validating', 'success', 'error'
                documentValidationMessage: '',
                documentValidated: false,
                uploadedFile: null,
                
                // Inicialización - poblar campos desde URL
                init() {
                    console.log('Iniciando Alpine.js component');
                    this.populateFromURL();
                    this.detectProductId();
                    // Ejecutar lógica de facturación después de poblar datos
                    this.handleDocTypeChange();
                    console.log('Después de populateFromURL, docType:', this.formData.docType);
                },
                
                // Poblar campos desde parámetros URL
                populateFromURL() {
                    const urlParams = new URLSearchParams(window.location.search);
                    
                    // Mapear parámetros de URL a campos del formulario
                    if (urlParams.get('name')) {
                        const fullName = urlParams.get('name').split(' ');
                        this.formData.firstName = fullName[0] || '';
                        this.formData.lastName = fullName.slice(1).join(' ') || '';
                    }
                    
                    if (urlParams.get('email')) {
                        this.formData.email = urlParams.get('email');
                    }
                    
                    if (urlParams.get('document_type')) {
                        const docTypeCode = urlParams.get('document_type');
                        console.log('Código recibido:', docTypeCode, 'tipo:', typeof docTypeCode);
                        
                        // Mapear códigos numéricos a tipos de documento
                        const docTypeMapping = {
                            '1': 'DNI',
                            '4': 'CE', 
                            '7': 'PASAPORTE'
                        };
                        
                        console.log('Mapeo disponible:', docTypeMapping);
                        const mappedValue = docTypeMapping[docTypeCode];
                        console.log('Valor mapeado directo:', mappedValue);
                        
                        if (mappedValue) {
                            this.formData.docType = mappedValue;
                            console.log('Asignado:', this.formData.docType);
                            // Verificar después de un momento si el select se actualizó
                            setTimeout(() => {
                                console.log('Verificación después de timeout - docType:', this.formData.docType);
                                const selectElement = document.querySelector('select[x-model="formData.docType"]');
                                console.log('Valor del select element:', selectElement ? selectElement.value : 'No encontrado');
                            }, 100);
                        } else {
                            console.log('No se encontró mapeo para código:', docTypeCode);
                            this.formData.docType = docTypeCode;
                        }
                    }
                    
                    if (urlParams.get('document_number')) {
                        this.formData.docNumber = urlParams.get('document_number');
                    }
                    
                    if (urlParams.get('phone')) {
                        this.formData.phone = urlParams.get('phone');
                    }
                    
                    if (urlParams.get('product_id')) {
                        this.setInscriptionFromProductId(urlParams.get('product_id'));
                    }
                    
                    if (urlParams.get('language')) {
                        this.language = urlParams.get('language');
                    }
                },
                
                // Configurar tipo de inscripción y categoría basado en product_id
                setInscriptionFromProductId(productId) {
                    // Buscar en productos de convencionista
                    for (const [id, data] of Object.entries(this.products.convencionista)) {
                        if (id === productId) {
                            this.formData.inscriptionType = 'convencionista';
                            this.formData.category = data.category;
                            return;
                        }
                    }
                    
                    // Buscar en productos de extemin
                    for (const [id, data] of Object.entries(this.products.extemin)) {
                        if (id === productId) {
                            this.formData.inscriptionType = 'extemin';
                            this.formData.category = data.category;
                            return;
                        }
                    }
                },
                
                async checkExistingInscriptions() {
                    if (!this.formData.docType || !this.formData.docNumber) {
                        this.existingInscriptions = [];
                        return;
                    }
                    
                    try {
                        // Mapear tipos de documento según la lógica del PHP
                        const docTypeMapping = {
                            'DNI': '1',
                            'CE': '4',
                            'PASAPORTE': '7'
                        };
                        
                        const mappedDocType = docTypeMapping[this.formData.docType] || this.formData.docType;
                        
                        const requestData = {
                            TipEvCod: 2,
                            EvenCod: 16,
                            TipoDocumento: mappedDocType,
                            NumeroDocumento: this.formData.docNumber
                        };
                        
                        const response = await fetch('/api/v1/check-inscriptions', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(requestData)
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            this.existingInscriptions = result.inscriptions || [];
                        } else {
                            this.existingInscriptions = [];
                        }
                    } catch (error) {
                        console.error('Error checking inscriptions:', error);
                        this.existingInscriptions = [];
                    }
                },
                
                // Validaciones de documentos por ID de producto
                validateDocumentForProduct() {
                    const productId = this.getProductIdFromURL();
                    
                    // Validaciones específicas por producto
                    if (productId === '151' || productId === '152') {
                        // Productos académicos: solo peruanos (DNI)
                        if (this.formData.docType !== 'DNI') {
                            this.showError(this.translations[this.currentLanguage].academicPeruOnly || 'Los productos académicos están disponibles solo para peruanos con DNI.');
                            return false;
                        }
                        // Si es DNI, verificar si necesita validación documental
                        if (!this.documentValidated) {
                            this.showAcademicValidationModal(productId);
                            return false;
                        }
                    }
                    
                    if (productId === '150') {
                        // Producto SME: solo peruanos (DNI)
                        if (this.formData.docType !== 'DNI') {
                            this.showError(this.translations[this.currentLanguage].smePeruOnly || 'El producto SME está disponible solo para peruanos con DNI.');
                            return false;
                        }
                        // Si es DNI, verificar si necesita validación documental
                        if (!this.documentValidated) {
                            this.showSMEValidationModal();
                            return false;
                        }
                    }
                    
                    return true;
                },
                
                getProductIdFromURL() {
                    const urlParams = new URLSearchParams(window.location.search);
                    return urlParams.get('product_id') || '';
                },
                
                showError(message) {
                    // Mostrar mensaje de error
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'error-message';
                    errorDiv.style.cssText = 'background: #dc3545; color: white; padding: 10px; margin: 10px 0; border-radius: 5px;';
                    errorDiv.textContent = message;
                    
                    const form = document.querySelector('.checkout-form');
                    if (form) {
                        form.insertBefore(errorDiv, form.firstChild);
                        setTimeout(() => errorDiv.remove(), 5000);
                    }
                },
                
                // Funciones para manejar la lógica de facturación
                handleDocTypeChange() {
                    // Validar documento para el producto
                    if (!this.validateDocumentForProduct()) {
                        // Si la validación falla, resetear el tipo de documento
                        this.formData.docType = '';
                        return;
                    }
                    
                    // Limpiar validaciones
                    this.rucValidationMessage = '';
                    this.rucValidationStatus = '';
                    
                    // Lógica automática según el tipo de documento
                    if (this.formData.docType === 'DNI') {
                        // DNI → Boleta automática con DNI peruano
                        this.formData.receiptType = '03';
                        this.formData.billingDocType = '1'; // DNI peruano
                        this.formData.billingDocNumber = this.formData.docNumber;
                        // Limpiar campos de RUC
                        this.formData.rucNumber = '';
                        this.formData.businessName = '';
                    } else if (this.formData.docType === 'CE' || this.formData.docType === 'PASAPORTE') {
                        // CE/Pasaporte → Por defecto Boleta con RUC extranjero
                        this.formData.receiptType = '03';
                        this.formData.billingDocType = '7'; // RUC extranjero
                        this.formData.rucNumber = this.formData.docNumber;
                        this.formData.businessName = (this.formData.firstName + ' ' + this.formData.lastName).trim();
                        this.formData.billingDocNumber = '';
                    } else {
                        // Para otros tipos, resetear campos de facturación
                        this.formData.receiptType = '03';
                        this.formData.billingDocType = '';
                        this.formData.rucNumber = '';
                        this.formData.businessName = '';
                        this.formData.billingDocNumber = '';
                    }
                },
                
                updateBillingDocOptions() {
                    // Limpiar validaciones
                    this.rucValidationMessage = '';
                    this.rucValidationStatus = '';
                    
                    // Aplicar lógica según tipo de documento y comprobante
                    if (this.formData.docType === 'DNI') {
                        if (this.formData.receiptType === '03') {
                            // Boleta con DNI peruano
                            this.formData.billingDocType = '1';
                            this.formData.billingDocNumber = this.formData.docNumber;
                            this.formData.rucNumber = '';
                            this.formData.businessName = '';
                        } else if (this.formData.receiptType === '01') {
                            // Factura con RUC peruano
                            this.formData.billingDocType = '6';
                            this.formData.billingDocNumber = '';
                            this.formData.rucNumber = '';
                            this.formData.businessName = '';
                        }
                    } else if (this.formData.docType === 'CE' || this.formData.docType === 'PASAPORTE') {
                        if (this.formData.receiptType === '03') {
                            // Boleta con RUC extranjero
                            this.formData.billingDocType = '7';
                            this.formData.rucNumber = this.formData.docNumber;
                            this.formData.businessName = (this.formData.firstName + ' ' + this.formData.lastName).trim();
                            this.formData.billingDocNumber = '';
                        } else if (this.formData.receiptType === '01') {
                            // Factura con RUC peruano
                            this.formData.billingDocType = '6';
                            this.formData.rucNumber = '';
                            this.formData.businessName = '';
                            this.formData.billingDocNumber = '';
                        }
                    } else {
                        // Para otros tipos de documento
                        if (this.formData.receiptType === '01') {
                            this.formData.billingDocType = '6'; // RUC peruano
                        } else {
                            this.formData.billingDocType = '';
                        }
                        this.formData.rucNumber = '';
                        this.formData.businessName = '';
                        this.formData.billingDocNumber = '';
                    }
                },
                
                updateBillingFields() {
                    // Limpiar campos cuando cambia el tipo de documento de facturación
                    this.formData.rucNumber = '';
                    this.formData.businessName = '';
                    this.formData.billingDocNumber = '';
                    this.rucValidationMessage = '';
                    this.rucValidationStatus = '';
                    
                    // Si es DNI, usar el número de documento principal
                    if (this.formData.billingDocType === '1') {
                        this.formData.billingDocNumber = this.formData.docNumber;
                    }
                },
                
                validateRUC() {
                    const ruc = this.formData.rucNumber.trim();
                    
                    // Limpiar timeout anterior
                    if (this.rucTimeout) {
                        clearTimeout(this.rucTimeout);
                    }
                    
                    // Resetear validación
                    this.rucValidationMessage = '';
                    this.rucValidationStatus = '';
                    
                    // Si es RUC extranjero (valor 7), no validar automáticamente
                    if (this.formData.billingDocType === '7') {
                        return;
                    }
                    
                    this.formData.businessName = '';
                    
                    // Validar formato de RUC (11 dígitos)
                    if (!/^\d{11}$/.test(ruc)) {
                        if (ruc.length > 0) {
                            this.rucValidationMessage = this.language === 'es' ? 'RUC debe tener 11 dígitos' : 'RUC must have 11 digits';
                            this.rucValidationStatus = 'error';
                        }
                        return;
                    }
                    
                    // Consultar RUC después de 1 segundo
                    this.rucTimeout = setTimeout(() => {
                        this.lookupRUC(ruc);
                    }, 1000);
                },
                
                async lookupRUC(ruc) {
                    console.log('🔍 Iniciando consulta RUC:', ruc);
                    
                    try {
                        this.rucValidationMessage = this.language === 'es' ? 'Consultando RUC...' : 'Looking up RUC...';
                        this.rucValidationStatus = '';
                        
                        console.log('📡 Enviando request a /api/v1/consultar-ruc');
                        const response = await fetch('/api/v1/consultar-ruc', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ ruc: ruc })
                        });
                        
                        console.log('📥 Response status:', response.status, response.statusText);
                        
                        if (response.ok) {
                            const result = await response.json();
                            console.log('📋 Response data:', result);
                            
                            // Verificar ambos formatos de respuesta (razonSocial y razon_social)
                            const businessName = result.razonSocial || result.razon_social || (result.data && result.data.razon_social);
                            console.log('🏢 Business name found:', businessName);
                            
                            if (result.success && businessName) {
                                this.formData.businessName = businessName;
                                this.rucValidationMessage = this.language === 'es' ? 'RUC válido' : 'Valid RUC';
                                this.rucValidationStatus = 'success';
                                console.log('✅ RUC validation successful');
                            } else {
                                this.rucValidationMessage = this.language === 'es' ? 'RUC no encontrado' : 'RUC not found';
                                this.rucValidationStatus = 'error';
                                console.log('❌ RUC not found or invalid response');
                            }
                        } else {
                            const errorText = await response.text();
                            console.error('❌ HTTP Error:', response.status, errorText);
                            this.rucValidationMessage = this.language === 'es' ? 'Error al consultar RUC' : 'Error looking up RUC';
                            this.rucValidationStatus = 'error';
                        }
                    } catch (error) {
                        console.error('💥 Network/Parse Error:', error);
                        this.rucValidationMessage = this.language === 'es' ? 'Error al consultar RUC' : 'Error looking up RUC';
                        this.rucValidationStatus = 'error';
                    }
                },
                
                // Detectar ID del producto y configurar selección de días
                detectProductId() {
                    const productId = this.getProductIdFromURL();
                    this.formData.productId = productId;
                    
                    // Para productos 158 y 154, inicialmente no mostrar selección de días
                    if (productId === '158' || productId === '154') {
                        this.showDaySelection = false; // Inicialmente false
                        this.currentProductPrice = this.productPrices[productId] || 250;
                    } else {
                        this.showDaySelection = false;
                    }
                },
                
                // Habilitar o deshabilitar selección de días
                enableDaySelection(enable) {
                    this.showDaySelection = enable;
                    if (enable) {
                        // Limpiar días seleccionados al activar
                        this.formData.selectedDays = [];
                    } else {
                        // Limpiar días seleccionados al desactivar
                        this.formData.selectedDays = [];
                    }
                },
                
                // Actualizar precio total basado en días seleccionados
                updateTotalPrice() {
                    // Este método se llama cuando cambia la selección de días
                    // El precio total se calcula automáticamente en la vista
                },
                
                // Validar que al menos un día esté seleccionado para productos de entrenamiento
                validateDaySelection() {
                    if (this.showDaySelection && this.formData.selectedDays.length === 0) {
                        this.showError(this.t('selectAtLeastOneDay') || 'Debes seleccionar al menos un día de asistencia.');
                        return false;
                    }
                    return true;
                },
                
                // Productos basados en productos.md con precios por categoría
                products: {
                    convencionista: {
                        150: { category: 'ASOCIADO_SME', price_usd: 1700, price_pen: 6290 },
                        151: { category: 'DOCENTE', price_usd: 400, price_pen: 1480 },
                        152: { category: 'ESTUDIANTE', price_usd: 250, price_pen: 925 },
                        154: { category: 'NO_ASOCIADO', price_usd: 1900, price_pen: 7030 },
                        155: { category: 'ASOCIADO_ACTIVO', price_usd: 1700, price_pen: 6290 }
                    },
                    extemin: {
                        158: { category: 'WEEK', price_usd: 790, price_pen: 2924 }
                    }
                },
                
                // Función para obtener el precio basado en tipo de inscripción, categoría y moneda
                getPrice() {
                    // Para productos de entrenamiento con selección de días
                    if (this.showDaySelection) {
                        const totalPrice = this.currentProductPrice * this.formData.selectedDays.length;
                        return `$${totalPrice.toLocaleString()} USD`;
                    }
                    
                    if (!this.formData.inscriptionType || !this.formData.category) return '';
                    
                    const productData = this.getProductData();
                    if (!productData) return '';
                    
                    const price = this.formData.currency === 'USD' ? productData.price_usd : productData.price_pen;
                    const symbol = this.formData.currency === 'USD' ? '$' : 'S/';
                    
                    return `${symbol}${price.toLocaleString()} ${this.formData.currency}`;
                },
                
                // Función para obtener el valor numérico del precio
                getPriceValue() {
                    // Para productos de entrenamiento con selección de días
                    if (this.showDaySelection && this.formData.selectedDays.length > 0) {
                        return this.currentProductPrice * this.formData.selectedDays.length;
                    }
                    
                    if (!this.formData.inscriptionType || !this.formData.category) return 0;
                    
                    const productData = this.getProductData();
                    if (!productData) return 0;
                    
                    return this.formData.currency === 'USD' ? productData.price_usd : productData.price_pen;
                },
                
                // Función para obtener los datos del producto basado en tipo y categoría
                getProductData() {
                    const typeProducts = this.products[this.formData.inscriptionType];
                    if (!typeProducts) return null;
                    
                    // Buscar el producto que coincida con la categoría seleccionada
                    for (const [productId, productData] of Object.entries(typeProducts)) {
                        if (productData.category === this.formData.category) {
                            return { ...productData, id: productId };
                        }
                    }
                    
                    return null;
                },
                
                // Función para obtener el ID del producto
                getProductId() {
                    const productData = this.getProductData();
                    return productData ? productData.id : null;
                },
                
                // Función para mostrar precio de convencionista basado en categoría
                getConvencionistaPrice() {
                    if (!this.formData.category) {
                        // Mostrar rango de precios si no hay categoría seleccionada
                        return this.formData.currency === 'USD' ? '$250 - $1,900 USD' : 'S/925 - S/7,030 PEN';
                    }
                    
                    const typeProducts = this.products.convencionista;
                    for (const [productId, productData] of Object.entries(typeProducts)) {
                        if (productData.category === this.formData.category) {
                            const price = this.formData.currency === 'USD' ? productData.price_usd : productData.price_pen;
                            const symbol = this.formData.currency === 'USD' ? '$' : 'S/';
                            return `${symbol}${price.toLocaleString()} ${this.formData.currency}`;
                        }
                    }
                    
                    return this.formData.currency === 'USD' ? '$250 - $1,900 USD' : 'S/925 - S/7,030 PEN';
                },
                
                // Función para mostrar precio de extemin
                getExteminPrice() {
                    const price = this.formData.currency === 'USD' ? 790 : 2924;
                    const symbol = this.formData.currency === 'USD' ? '$' : 'S/';
                    return `${symbol}${price.toLocaleString()} ${this.formData.currency}`;
                },
                

                
                isFormValid() {
                    const basicValidation = this.formData.docType && 
                           this.formData.docNumber && 
                           this.formData.firstName && 
                           this.formData.lastName && 
                           this.formData.email && 
                           this.formData.phone && 
                           this.formData.inscriptionType && 
                           this.formData.category;
                    
                    // Si se requiere selección de días, validar que al menos uno esté seleccionado
                    if (this.showDaySelection) {
                        return basicValidation && this.formData.selectedDays.length > 0;
                    }
                    
                    return basicValidation;
                },
                
                async processOrder() {
                    if (!this.isFormValid()) {
                        alert('Por favor complete todos los campos requeridos');
                        return;
                    }
                    
                    this.isLoading = true;
                    
                    try {
                        const productId = this.getProductId();
                        if (!productId) {
                            throw new Error('No se pudo determinar el producto');
                        }
                        
                        const orderData = {
                            product_id: productId,
                            email: this.formData.email,
                            nombres: this.formData.firstName,
                            apellidos: this.formData.lastName,
                            celular: this.formData.phone,
                            tipo_documento: this.formData.docType,
                            numero_documento: this.formData.docNumber,
                            inscription_type: this.formData.inscriptionType,
                            category: this.formData.category,
                            currency: this.formData.currency,
                            total_amount: this.getPriceValue(),
                            language: this.language,
                            status: 'pending'
                        };
                        
                        // Agregar días seleccionados para productos de entrenamiento
                        if (this.showDaySelection && this.formData.selectedDays.length > 0) {
                            orderData.selected_days = this.formData.selectedDays;
                            orderData.days_count = this.formData.selectedDays.length;
                            orderData.price_per_day = this.currentProductPrice;
                        }
                        
                        const response = await fetch('/api/v1/orders', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(orderData)
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            
                            // Preparar datos completos para la página de agradecimiento
                            const completeOrderData = {
                                ...orderData,
                                id: result.id,
                                created_at: new Date().toISOString()
                            };
                            
                            // Guardar en localStorage como respaldo
                            localStorage.setItem('lastOrderData', JSON.stringify(completeOrderData));
                            
                            // Redirigir a página de agradecimiento con datos
                            const orderDataParam = encodeURIComponent(JSON.stringify(completeOrderData));
                            window.location.href = `thank-you.html?orderData=${orderDataParam}`;
                        } else {
                            const error = await response.json();
                            const errorMessage = this.language === 'es' ? 'Error al procesar la inscripción' : 'Error processing inscription';
                            alert(`${errorMessage}: ${error.detail || 'Error desconocido'}`);
                        }
                    } catch (error) {
                        console.error('Error al enviar formulario:', error);
                        const errorMessage = this.language === 'es' ? 'Error de conexión. Por favor, intente nuevamente.' : 'Connection error. Please try again.';
                        alert(errorMessage);
                    } finally {
                        this.isLoading = false;
                    }
                },
                
                // Funciones para validación documental
                showAcademicValidationModal(productId) {
                    this.documentValidationType = 'academic';
                    this.academicType = productId === '151' ? 'teacher' : 'student';
                    this.showDocumentValidationModal = true;
                    this.documentValidationStatus = '';
                    this.documentValidationMessage = '';
                },
                
                showSMEValidationModal() {
                    this.documentValidationType = 'sme';
                    this.showDocumentValidationModal = true;
                    this.documentValidationStatus = '';
                    this.documentValidationMessage = '';
                },
                
                closeDocumentValidationModal() {
                    this.showDocumentValidationModal = false;
                    this.uploadedFile = null;
                    this.documentValidationStatus = '';
                    this.documentValidationMessage = '';
                },
                
                handleFileUpload(event) {
                    const file = event.target.files[0];
                    if (file) {
                        this.processFile(file);
                    }
                },
                
                handleDrop(event) {
                    event.preventDefault();
                    event.stopPropagation();
                    
                    // Remover clases de estilo de drag
                    event.target.classList.remove('border-perumin', 'bg-perumin-light');
                    
                    const files = event.dataTransfer.files;
                    if (files.length > 0) {
                        this.processFile(files[0]);
                    }
                },
                
                processFile(file) {
                    // Validar tipo de archivo
                    const allowedTypes = ['image/jpeg', 'image/png', 'image/jpg', 'application/pdf'];
                    if (!allowedTypes.includes(file.type)) {
                        this.showError('Solo se permiten archivos JPG, PNG o PDF.');
                        return;
                    }
                    
                    // Validar tamaño (máximo 5MB)
                    if (file.size > 5 * 1024 * 1024) {
                        this.showError('El archivo no debe superar los 5MB.');
                        return;
                    }
                    
                    this.uploadedFile = file;
                    console.log('Archivo procesado:', file.name, file.type, file.size);
                },
                
                async validateDocument() {
                    console.log('Iniciando validación documental...');
                    
                    if (!this.uploadedFile) {
                        console.error('Error: No se ha seleccionado archivo');
                        this.showError('Debe seleccionar un archivo.');
                        return;
                    }
                    
                    if (!this.formData.firstName || !this.formData.lastName) {
                        console.error('Error: Campos de nombre incompletos');
                        this.showError('Debe completar los campos de nombre y apellido.');
                        return;
                    }
                    
                    this.documentValidationStatus = 'validating';
                    this.documentValidationMessage = this.language === 'es' ? 'Validando documento...' : 'Validating document...';
                    
                    try {
                        const formData = new FormData();
                        formData.append('file', this.uploadedFile);
                        formData.append('firstName', this.formData.firstName);
                        formData.append('lastName', this.formData.lastName);
                        formData.append('validationType', this.documentValidationType);
                        if (this.documentValidationType === 'academic') {
                            formData.append('academicType', this.academicType);
                        }
                        
                        console.log('Datos enviados al backend:', {
                            fileName: this.uploadedFile.name,
                            fileType: this.uploadedFile.type,
                            fileSize: this.uploadedFile.size,
                            firstName: this.formData.firstName,
                            lastName: this.formData.lastName,
                            validationType: this.documentValidationType,
                            academicType: this.academicType
                        });
                        
                        console.log('Realizando petición POST a http://localhost:8000/api/v1/validate-document');
                        const response = await fetch('http://localhost:8000/api/v1/validate-document', {
                            method: 'POST',
                            body: formData
                        });
                        
                        console.log('Respuesta recibida:', response.status, response.statusText);
                        
                        if (!response.ok) {
                            console.error('Error HTTP:', response.status, await response.text());
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const result = await response.json();
                        console.log('Resultado de validación:', result);
                        
                        if (result.valid) {
                            console.log('Documento validado exitosamente');
                            this.documentValidationStatus = 'success';
                            this.documentValidationMessage = this.language === 'es' ? 'Documento validado exitosamente.' : 'Document validated successfully.';
                            this.documentValidated = true;
                            
                            setTimeout(() => {
                                this.closeDocumentValidationModal();
                            }, 2000);
                        } else {
                            console.log('Documento rechazado:', result.reason);
                            this.documentValidationStatus = 'error';
                            this.documentValidationMessage = result.reason || (this.language === 'es' ? 'Error en la validación del documento.' : 'Document validation error.');
                        }
                    } catch (error) {
                        console.error('Error en validación documental:', error);
                        console.error('Stack trace:', error.stack);
                        this.documentValidationStatus = 'error';
                        this.documentValidationMessage = this.language === 'es' ? 'Error de conexión. Intente nuevamente.' : 'Connection error. Please try again.';
                    }
                },
                
                resetForm() {
                    this.formData = {
                        docType: '',
                        docNumber: '',
                        firstName: '',
                        lastName: '',
                        email: '',
                        phone: '',
                        inscriptionType: '',
                        category: '',
                        currency: 'USD',
                        isLoading: false
                    };
                    this.existingInscriptions = [];
                },
                setLanguage(lang) {
                    this.language = lang;
                },
                t(key) {
                    return this.translations[this.language][key] || key;
                }
            }
        }
    </script>

    <!-- Modal de Validación Documental con Tailwind -->
    <div x-show="showDocumentValidationModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 transition-opacity duration-300" @click="closeDocumentValidationModal">
        <div class="bg-white rounded-xl shadow-xl max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto" @click.stop>
            <!-- Header -->
            <div class="flex items-center justify-between p-6 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-perumin">
                    <span x-show="documentValidationType === 'academic'" x-text="language === 'es' ? 'Validación de Documento Académico' : 'Academic Document Validation'"></span>
                    <span x-show="academicType === 'teacher'" x-text="' (' + (language === 'es' ? 'Docente' : 'Teacher') + ')'"></span>
                    <span x-show="academicType === 'student'" x-text="' (' + (language === 'es' ? 'Estudiante' : 'Student') + ')'"></span>
                    <span x-show="documentValidationType === 'sme'" x-text="language === 'es' ? 'Validación de Documento SME' : 'SME Document Validation'"></span>
                </h3>
                <button @click="closeDocumentValidationModal" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Body -->
            <div class="p-6">
                <!-- Información de validación -->
                <div class="mb-6">
                    <p class="text-gray-600 text-sm leading-relaxed" 
                       x-show="documentValidationType === 'academic' && academicType === 'teacher'" 
                       x-text="language === 'es' ? 'Por favor, suba su documento que acredite su condición de docente (constancia de trabajo, resolución, etc.)' : 'Please upload your document that proves your teaching status (work certificate, resolution, etc.)'">
                    </p>
                    <p class="text-gray-600 text-sm leading-relaxed" 
                       x-show="documentValidationType === 'academic' && academicType === 'student'" 
                       x-text="language === 'es' ? 'Por favor, suba su documento que acredite su condición de estudiante (constancia de estudios, carnet universitario, etc.)' : 'Please upload your document that proves your student status (study certificate, university ID, etc.)'">
                    </p>
                    <p class="text-gray-600 text-sm leading-relaxed" 
                       x-show="documentValidationType === 'sme'" 
                       x-text="language === 'es' ? 'Por favor, suba su documento que acredite su condición como miembro SME habilitado' : 'Please upload your document that proves your status as an enabled SME member'">
                    </p>
                </div>
                
                <!-- Upload de archivo con Drag & Drop -->
                <div class="mb-6">
                    <label class="block cursor-pointer">
                        <input type="file" @change="handleFileUpload" accept=".jpg,.jpeg,.png,.pdf" class="hidden">
                        <div 
                            class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-perumin hover:bg-gray-50 transition-all duration-200"
                            @dragover.prevent="$event.dataTransfer.dropEffect = 'copy'; $el.classList.add('border-perumin', 'bg-perumin-light')"
                            @dragleave.prevent="$el.classList.remove('border-perumin', 'bg-perumin-light')"
                            @drop.prevent="handleDrop($event)"
                        >
                            <svg class="w-12 h-12 text-gray-400 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                            </svg>
                            <span class="block text-sm font-medium text-gray-600 mb-1" 
                                  x-show="!uploadedFile" 
                                  x-text="language === 'es' ? 'Haga clic o arrastre archivo aquí' : 'Click or drag file here'">
                            </span>
                            <span class="block text-sm font-semibold text-perumin mb-1" 
                                  x-show="uploadedFile" 
                                  x-text="uploadedFile ? uploadedFile.name : ''">
                            </span>
                            <small class="text-xs text-gray-500" 
                                   x-text="language === 'es' ? 'Formatos: JPG, PNG, PDF (máx. 5MB)' : 'Formats: JPG, PNG, PDF (max. 5MB)'">
                            </small>
                        </div>
                    </label>
                </div>
                
                <!-- Estado de validación -->
                <div x-show="documentValidationStatus">
                    <div x-show="documentValidationStatus === 'validating'" 
                         class="flex items-center gap-3 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <svg class="w-5 h-5 text-yellow-600 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        <span class="text-sm text-yellow-800" x-text="documentValidationMessage"></span>
                    </div>
                    
                    <div x-show="documentValidationStatus === 'success'" 
                         class="flex items-center gap-3 p-3 bg-green-50 border border-green-200 rounded-lg">
                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        <span class="text-sm text-green-800" x-text="documentValidationMessage"></span>
                    </div>
                    
                    <div x-show="documentValidationStatus === 'error'" 
                         class="flex items-center gap-3 p-3 bg-red-50 border border-red-200 rounded-lg">
                        <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                        <span class="text-sm text-red-800" x-text="documentValidationMessage"></span>
                    </div>
                </div>
            </div>
            
            <!-- Footer -->
            <div class="flex gap-3 p-6 border-t border-gray-200">
                <button @click="closeDocumentValidationModal" 
                        class="flex-1 px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg font-medium transition-colors"
                        x-text="language === 'es' ? 'Cancelar' : 'Cancel'">
                </button>
                <button @click="validateDocument" 
                        :disabled="!uploadedFile || documentValidationStatus === 'validating'"
                        :class="!uploadedFile || documentValidationStatus === 'validating' ? 'opacity-50 cursor-not-allowed' : ''"
                        class="flex-1 px-4 py-2 bg-perumin text-white hover:bg-perumin-dark rounded-lg font-medium transition-colors"
                        x-text="language === 'es' ? 'Validar Documento' : 'Validate Document'">
                </button>
            </div>
        </div>
    </div>

</body>
</html>